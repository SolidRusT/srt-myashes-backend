# KEDA ScaledObject for autoscaling based on HTTP traffic
# Requires KEDA to be installed in the cluster
# See: https://keda.sh/docs/2.13/scalers/prometheus/
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: myashes-backend-scaledobject
  namespace: myashes-backend
spec:
  scaleTargetRef:
    name: myashes-backend
  minReplicaCount: 2  # Maintain HA (was 0, but cold starts are bad for UX)
  maxReplicaCount: 10
  cooldownPeriod: 300  # 5 minutes before scaling down
  pollingInterval: 15

  triggers:
  # Scale based on CPU utilization
  - type: cpu
    metricType: Utilization
    metadata:
      value: "70"  # Scale up when CPU > 70%

  # Scale based on memory utilization
  - type: memory
    metricType: Utilization
    metadata:
      value: "80"  # Scale up when memory > 80%

  # Scale based on HTTP requests per second (via nginx ingress metrics)
  - type: prometheus
    metadata:
      serverAddress: http://kube-prometheus-stack-prometheus.monitoring:9090
      metricName: myashes_http_requests_per_second
      query: sum(rate(nginx_ingress_controller_requests{exported_service="myashes-backend"}[2m]))
      threshold: "50"  # Scale up when > 50 req/sec

---
# Optional: Configure scale-to-zero behavior
apiVersion: v1
kind: ConfigMap
metadata:
  name: myashes-backend-keda-config
  namespace: myashes-backend
data:
  # Note: Scale-to-zero means cold starts. Consider keeping minReplicaCount: 1
  # if low latency is critical for the first request.
  description: |
    This backend scales to zero after 5 minutes of inactivity.
    First request after scale-to-zero may take 10-30 seconds.
    For production, consider setting minReplicaCount: 1.
